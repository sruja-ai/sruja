name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.4'
    
    - name: Build
      run: go build -v ./...
    
    - name: Run tests
      run: go test -v -coverprofile=coverage.out ./...
    
    - name: Run Codacy Coverage Reporter
      uses: codacy/codacy-coverage-reporter-action@v1
      with:
        project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
        coverage-reports: coverage.out
    
    - name: Run linter
      uses: golangci/golangci-lint-action@v9
      with:
        version: v2.6.2

  lint-typescript:
    name: Lint TypeScript/JavaScript
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npm run lint

  test-typescript:
    name: Test TypeScript/JavaScript
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests with coverage
      run: npm run test:coverage
      continue-on-error: true  # Don't fail CI if coverage thresholds not met yet
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: |
          packages/shared/coverage/lcov.info
          packages/ui/coverage/lcov.info
        flags: typescript
        name: typescript-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
    
    - name: Run security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
    
    - name: Check bundle sizes
      run: npm run build --filter=@sruja/shared --filter=@sruja/ui && npm run size || echo "Bundle size check skipped (packages use source TypeScript, not bundles)"
      continue-on-error: true

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      working-directory: apps/website
    
    - name: Build website
      run: npm run build
      working-directory: apps/website
    
    - name: Run E2E tests
      run: npm run test:e2e
      working-directory: apps/website
      env:
        CI: true
        # Override baseURL to use preview server for built site
        PLAYWRIGHT_BASE_URL: 'http://localhost:4321'
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: apps/website/playwright-report/
        retention-days: 30

  build-examples:
    name: Build Examples
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.4'
    
    - name: Build CLI
      run: go build -o sruja ./cmd/sruja
    
    - name: Compile examples
      run: |
        ./sruja compile examples/example.sruja
        ./sruja compile examples/full_features.sruja
    
    - name: Lint examples
      run: |
        ./sruja lint examples/example.sruja
        ./sruja lint examples/full_features.sruja

