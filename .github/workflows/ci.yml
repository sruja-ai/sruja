name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.4'
    
    - name: Build
      run: go build -v ./...
    
    - name: Run tests
      run: go test -v -coverprofile=coverage.out ./...
    
    - name: Run Codacy Coverage Reporter
      uses: codacy/codacy-coverage-reporter-action@v1
      with:
        project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
        coverage-reports: coverage.out
    
    - name: Run linter
      uses: golangci/golangci-lint-action@v9
      with:
        version: v2.6.2

  build-examples:
    name: Build Examples
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.4'
    
    - name: Build CLI
      run: go build -o sruja ./cmd/sruja
    
    - name: Compile examples
      run: |
        ./sruja compile examples/example.sruja
        ./sruja compile examples/full_features.sruja
    
    - name: Lint examples
      run: |
        ./sruja lint examples/example.sruja
        ./sruja lint examples/full_features.sruja

  learn-site-checks:
    name: Learn Site Checks
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.4'
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: learn/package-lock.json
    - name: Install Hugo
      run: |
        sudo apt-get update && sudo apt-get install -y hugo
    - name: Install learn app dependencies
      working-directory: learn
      run: npm ci
    - name: Build WASM for learn
      run: make build-learn
    - name: Build Learn site with warnings as errors
      working-directory: learn
      run: hugo -D --panicOnWarning --minify
    - name: Validate tutorials code blocks compile (existing tests)
      run: make test-learn-code
    - name: Quick SEO check
      working-directory: learn
      run: |
        echo "=== Quick SEO Validation ==="
        if [ ! -f "public/sitemap.xml" ]; then
          echo "❌ sitemap.xml missing"
          exit 1
        fi
        if [ ! -f "public/robots.txt" ]; then
          echo "❌ robots.txt missing"
          exit 1
        fi
        og_count=$(grep -r "og:title" public/*.html 2>/dev/null | wc -l | tr -d ' ')
        if [ "$og_count" -eq 0 ]; then
          echo "❌ No Open Graph tags found"
          exit 1
        fi
        echo "✓ Basic SEO checks passed"
