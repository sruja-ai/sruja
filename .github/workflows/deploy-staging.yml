name: Deploy Staging

on:
  push:
    branches:
      - 'release/*'

permissions:
  contents: write

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract Version
        id: version
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          VERSION=${BRANCH_NAME#release/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Calculate RC Number
        id: rc
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG_PREFIX="$VERSION-RC"
          EXISTING_TAGS=$(git tag -l "$TAG_PREFIX*")
          if [ -z "$EXISTING_TAGS" ]; then
            RC_NUM=1
          else
            # Extract highest RC number
            RC_NUM=$(echo "$EXISTING_TAGS" | sed "s/$TAG_PREFIX//" | sort -n | tail -1)
            RC_NUM=$((RC_NUM + 1))
          fi
          echo "rc_tag=$TAG_PREFIX$RC_NUM" >> $GITHUB_OUTPUT

      - name: Create RC Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.rc.outputs.rc_tag }}
          git push origin ${{ steps.rc.outputs.rc_tag }}

      - name: Deploy to Staging
        run: |
          echo "Deploying ${{ steps.rc.outputs.rc_tag }} to Staging..."
          # Add actual deployment steps here (e.g., build website, publish VS Code pre-release)
