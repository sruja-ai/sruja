name: Hotfix Publish

on:
  workflow_dispatch:
    inputs:
      patchVersion:
        description: 'Patch version (e.g., v0.1.1)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: hotfix-${{ inputs.patchVersion }}
  cancel-in-progress: true

jobs:
  create-hotfix-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: ./.github/actions/setup-go

      - name: Verify hotfix branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          if [[ ! "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            echo "‚ùå Error: This workflow must be run from a 'hotfix/...' branch. Current branch: $BRANCH_NAME"
            exit 1
          fi

      - name: Pre-build checks
        run: |
          go build -v ./...
          go test -v ./pkg/... ./cmd/...

      - name: Setup GPG for signing
        uses: ./.github/actions/setup-gpg
        if: env.GPG_PRIVATE_KEY != ''
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Normalize version tag
        id: version
        env:
          INPUT_VERSION: ${{ inputs.patchVersion }}
        run: |
          VERSION="$INPUT_VERSION"
          # Ensure 'v' prefix
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="v${VERSION}"
          fi
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "üì¶ Hotfix version: ${VERSION}"

      - name: Create and push tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists"
          else
            # Configure git user
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Create signed tag if GPG is configured, otherwise unsigned
            if [ -n "${GPG_KEY_ID:-}" ]; then
              git tag -s "$TAG" -m "Hotfix $TAG"
              echo "‚úÖ Created signed tag: $TAG"
            else
              git tag -a "$TAG" -m "Hotfix $TAG"
              echo "‚ö†Ô∏è  Created unsigned tag: $TAG (GPG_PRIVATE_KEY secret not configured)"
            fi
            git push origin "$TAG"
            echo "‚úÖ Pushed tag: $TAG"
          fi

      - name: Cleanup on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          gh release delete "$TAG" -y || true
          git tag -d "$TAG" || true
          git push --delete origin "$TAG" || true

  # Unified release will handle all deployments when tag is pushed
  # This job just creates the tag, unified-release does the rest
  merge-back:
    runs-on: ubuntu-latest
    needs: create-hotfix-tag
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Merge hotfix into main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PATCH_VERSION: ${{ inputs.patchVersion }}
        run: |
          # Extract version without 'v' prefix for branch name
          VERSION="${PATCH_VERSION#v}"
          TAG="${{ needs.create-hotfix-tag.outputs.tag }}"
          gh pr create \
            --base main \
            --head hotfix/$VERSION \
            --title "Merge hotfix $TAG to main" \
            --body "Automatic merge of hotfix $TAG into main"
