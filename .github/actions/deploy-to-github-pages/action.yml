name: "Deploy to GitHub Pages"
description: "Deploy site contents to a GitHub Pages repository"
inputs:
  site-path:
    description: "Path to the site contents to deploy"
    required: true
  target-repo:
    description: "Target repository (owner/repo)"
    required: true
  target-branch:
    description: "Target branch to deploy to"
    required: false
    default: "main"
  app-id:
    description: "GitHub App ID (from secrets)"
    required: true
  app-private-key:
    description: "GitHub App private key (from secrets)"
    required: true
  commit-message:
    description: "Commit message template (supports ${{ github.ref_name }}, ${{ github.sha }})"
    required: true

runs:
  using: "composite"
  steps:
    - name: Create GitHub App token
      id: app-token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      with:
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.app-private-key }}
        owner: sruja-ai
        repositories: ${{ inputs.target-repo }}

    - name: Get GitHub App User ID
      id: get-user-id
      shell: bash
      run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}

    - name: Checkout target repo
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        repository: sruja-ai/${{ inputs.target-repo }}
        ref: ${{ inputs.target-branch }}
        token: ${{ steps.app-token.outputs.token }}
        path: target

    - name: Verify checkout succeeded
      shell: bash
      run: |
        if [ ! -d "target" ]; then
          echo "Error: Checkout failed - target directory not found"
          echo "Repository: sruja-ai/${{ inputs.target-repo }}"
          exit 1
        fi
        if [ ! -d "target/.git" ]; then
          echo "Error: Checkout failed - target/.git directory not found"
          echo "Repository: sruja-ai/${{ inputs.target-repo }}"
          echo "This may indicate the repository doesn't exist or the token lacks access"
          exit 1
        fi
        # Verify it's actually a git repository
        cd target
        if ! git rev-parse --git-dir > /dev/null 2>&1; then
          echo "Error: target directory exists but is not a valid git repository"
          echo "Repository: sruja-ai/${{ inputs.target-repo }}"
          exit 1
        fi
        echo "âœ… Checkout verified - git repository is valid"

    - name: Copy site contents
      shell: bash
      run: |
        # If site-path ends with /designer, deploy to target/designer
        if [[ "${{ inputs.site-path }}" == *"/designer" ]]; then
          rm -rf target/designer
          cp -r ${{ inputs.site-path }} target/designer
        else
          # Remove existing contents except .git
          find target -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          # Copy all contents including _astro directory and hidden files
          # Using cp -a to preserve all attributes and copy everything (including _astro)
          cp -a ${{ inputs.site-path }}/. target/
          # Verify _astro directory was copied
          if [ ! -d "target/_astro" ]; then
            echo "âŒ Error: _astro directory not found after copy"
            echo "Source directory contents:"
            ls -la ${{ inputs.site-path }}/
            echo "Target directory contents:"
            ls -la target/
            exit 1
          fi
          echo "âœ… _astro directory verified"
          # Ensure .nojekyll exists to prevent Jekyll from processing _astro
          touch target/.nojekyll
        fi

    - name: Create deployment README
      shell: bash
      run: |
        # Only create README for root site deployments, not for designer subdirectory
        if [[ "${{ inputs.site-path }}" != *"/designer" ]]; then
          cat > target/README.md << 'EOF'
        # Deployment Repository

        âš ï¸ **This repository is for deployment purposes only.**

        This repository contains the built and deployed version of the Sruja website/application.

        **For source code, issues, contributions, and documentation, please refer to the main repository:**

        ðŸ”— **[sruja-ai/sruja](https://github.com/sruja-ai/sruja)**

        ---

        ## What is this?

        This repository is automatically updated by GitHub Actions workflows from the main [sruja](https://github.com/sruja-ai/sruja) repository. It contains the built static files that are served via GitHub Pages.

        **Do not:**
        - Make manual changes to this repository
        - Open issues or pull requests here
        - Use this repository as a reference for development

        **Do:**
        - Visit the [main repository](https://github.com/sruja-ai/sruja) for all development activities
        - Report issues in the [main repository](https://github.com/sruja-ai/sruja/issues)
        - Contribute via pull requests to the [main repository](https://github.com/sruja-ai/sruja)

        ---

        *This README is automatically generated and deployed.*
        EOF
          echo "âœ… Created deployment README"
        else
          echo "â­ï¸  Skipping README creation (designer subdirectory deployment)"
        fi

    - name: Configure git
      working-directory: target
      shell: bash
      run: |
        git config user.name "${{ steps.app-token.outputs.app-slug }}[bot]"
        git config user.email "${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"

    - name: Commit and push
      working-directory: target
      shell: bash
      run: |
        git add -A
        if git diff --cached --quiet; then 
          echo "No changes to deploy"
        else 
          COMMIT_MSG="${{ inputs.commit-message }}"
          git commit -m "$COMMIT_MSG"
          git push origin HEAD:${{ inputs.target-branch }}
        fi
