<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 {{.Width}} {{.Height}}" preserveAspectRatio="xMidYMid meet" style="background-color: {{.Background}};" role="img" aria-labelledby="diagram-title diagram-desc">
{{if .Title}}<title id="diagram-title">{{xml .Title}}</title>{{end}}
<desc id="diagram-desc">Architecture diagram generated by Sruja</desc>
<defs>
{{.Defs}}
<style>
{{if .EmbedFonts}}@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');{{end}}
text { font-family: {{.Theme.FontFamily}}; }
.node { transition: all 0.2s ease; }
.node:hover { filter: brightness(0.95); }
</style>
</defs>
{{if .Metadata}}
<metadata>
  {{range $k, $v := .Metadata}}
  <{{$k}}>{{xml $v}}</{{$k}}>
  {{end}}
</metadata>
{{end}}
{{if .ShowGrid}}
<g role="presentation" aria-hidden="true">
{{range .GridLines}}
<line x1="{{.X1}}" y1="{{.Y1}}" x2="{{.X2}}" y2="{{.Y2}}" stroke="{{.Color}}" stroke-width="0.5" opacity="{{.Opacity}}"/>
{{end}}
</g>
{{end}}
{{if .ShowTitle}}
<text x="{{.TitleX}}" y="{{.TitleY}}" fill="{{.Theme.TitleColor}}" font-size="{{.Theme.TitleFontSize}}" font-weight="600" letter-spacing="-0.5" role="heading" aria-level="1">{{xml .Title}}</text>
{{end}}
{{if .Legend.Show}}
<g transform="translate({{.Legend.X}},{{.Legend.Y}})" role="region" aria-label="Legend">
  <rect x="0" y="0" width="200" height="{{add 30 (mul (len .Legend.Items) 26)}}" rx="8" ry="8" fill="#fff" stroke="#ccc" stroke-width="1"/>
  <text x="10" y="20" fill="{{.Theme.TitleColor}}" font-size="13" font-weight="600">{{xml .Legend.Title}}</text>
  {{range $i, $it := .Legend.Items}}
    <g transform="translate(10,{{add 40 (mul $i 26)}})">
      {{if $it.Icon}}
      <g transform="scale(0.7)" fill="none" stroke="{{$it.Stroke}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <use href="#{{$it.Icon}}"/>
      </g>
      {{else}}
      <rect x="0" y="0" width="16" height="16" rx="3" ry="3" fill="{{$it.Fill}}" stroke="{{$it.Stroke}}" stroke-width="1.5"/>
      {{end}}
      <text x="28" y="12" fill="{{$.Theme.LabelColor}}" font-size="12">{{xml $it.Label}}</text>
    </g>
  {{end}}
</g>
{{end}}
{{range .Groups}}
<g role="group" aria-label="{{xml .Title}}">
<rect x="{{.X}}" y="{{.Y}}" width="{{.Width}}" height="{{.Height}}" rx="12" ry="12" fill="{{.Fill}}" stroke="{{.Stroke}}" stroke-width="2"/>
<text x="{{add .X 14}}" y="{{add .Y 32}}" fill="{{.TitleColor}}" font-size="14" font-weight="600">{{xml .Title}}</text>
</g>
{{end}}
{{range .Edges}}
<g role="img" aria-label="{{xml .Title}}">
<title>{{xml .Title}}{{if .Description}}: {{xml .Description}}{{end}}</title>
{{if .Description}}<desc>{{xml .Description}}</desc>{{end}}
{{if .Curved}}
<path d="M {{.X1}} {{.Y1}} C {{.CX1}} {{.CY1}}, {{.CX2}} {{.CY2}}, {{.X2}} {{.Y2}}" stroke="{{.Color}}" stroke-width="{{.Width}}" fill="none" marker-end="url(#arrow)"/>
{{else}}
<line x1="{{.X1}}" y1="{{.Y1}}" x2="{{.X2}}" y2="{{.Y2}}" stroke="{{.Color}}" stroke-width="{{.Width}}" marker-end="url(#arrow)"/>
{{end}}
{{if .Label}}
{{if .LabelBg}}
<rect x="{{sub (sub .LabelX (mul (len .Label) 3)) 4}}" y="{{sub .LabelY 8}}" width="{{add (mul (len .Label) 6) 8}}" height="16" rx="4" fill="{{$.Background}}" opacity="0.9"/>
{{end}}
<text x="{{.LabelX}}" y="{{.LabelY}}" fill="{{$.Theme.LabelColor}}" font-size="{{$.Theme.LabelFontSize}}" text-anchor="middle" dominant-baseline="middle">{{xml .Label}}</text>
{{end}}
</g>
{{end}}
{{range .Nodes}}
<g role="img" aria-label="{{xml .Title}}" class="node">
<title>{{xml .Title}}{{if .Description}}
{{xml .Description}}{{end}}</title>
{{if .Description}}<desc>{{xml .Description}}</desc>{{end}}
<rect x="{{.X}}" y="{{.Y}}" width="{{.Width}}" height="{{.Height}}" rx="10" ry="10" fill="{{if .Gradient}}{{.Gradient}}{{else}}{{.Fill}}{{end}}" stroke="{{.Stroke}}" stroke-width="{{.StrokeWidth}}"{{if .Filter}} filter="{{.Filter}}"{{end}}{{if .Dash}} {{.Dash}}{{end}}/>
{{if .Icon}}
<g transform="translate({{.IconX}},{{.IconY}})" fill="none" stroke="{{.Stroke}}" stroke-width="{{.IconStrokeWidth}}" stroke-linecap="round" stroke-linejoin="round">
  <use href="#{{.Icon}}" width="{{.IconW}}" height="{{.IconH}}"/>
</g>
{{end}}
<text x="{{.LabelX}}" y="{{.LabelY}}" fill="{{.LabelColor}}" font-size="{{.LabelSize}}" font-weight="500" text-anchor="{{if .Icon}}start{{else}}middle{{end}}" dominant-baseline="middle">
  {{- $lines := .WrappedLines -}}
  {{- $lh := .LineHeight -}}
  {{- $count := len $lines -}}
  {{- $base := div (mul (sub $count 1) $lh) 2 -}}
  {{- $node := . -}}
  {{- range $i, $ln := $lines -}}
    <tspan x="{{$node.LabelX}}" dy="{{sub (mul $i $lh) $base}}">{{xml $ln}}</tspan>
  {{- end -}}
</text>
</g>
{{end}}
</svg>
