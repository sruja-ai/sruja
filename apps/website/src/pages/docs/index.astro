---
// apps/website/src/pages/docs/index.astro
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ContentPage from '@/features/content/components/ContentPage.astro';
import ExpandableCard from '@/features/content/components/ExpandableCard.astro';
import { sortByWeight } from '@/features/content/utils/sorting';
import { transformToContentListItem } from '@/features/content/utils/transform';

const allDocs = await getCollection('docs');
const sortedDocs: CollectionEntry<'docs'>[] = sortByWeight(allDocs);

// Categorize docs by weight ranges
const gettingStarted: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.data.weight !== undefined && d.data.weight >= 0 && d.data.weight < 10 && !d.slug.includes('/'));
const guides: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.data.weight !== undefined && d.data.weight >= 20 && d.data.weight < 50 && !d.slug.includes('/'));
const reference: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.data.weight !== undefined && d.data.weight >= 50 && d.data.weight < 70 && !d.slug.includes('/'));
const examples: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.data.weight !== undefined && d.data.weight >= 80 && d.data.weight < 90 && !d.slug.includes('/'));
const community: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.data.weight !== undefined && d.data.weight >= 90 && d.data.weight < 100 && !d.slug.includes('/'));
const styleGuide: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.data.weight !== undefined && d.data.weight >= 100 && !d.slug.includes('/'));

// Concepts (in subfolder)
const concepts: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.slug.startsWith('concepts/'));
const conceptsOverview = concepts.find(d => d.slug === 'concepts/overview');
const coreConcepts: CollectionEntry<'docs'>[] = concepts.filter(d => {
  const weight = d.data.weight || 999;
  return weight >= 10 && weight < 20;
});
const relationsConcepts: CollectionEntry<'docs'>[] = concepts.filter(d => {
  const weight = d.data.weight || 999;
  return weight >= 20 && weight < 30;
});
const advancedConcepts: CollectionEntry<'docs'>[] = concepts.filter(d => {
  const weight = d.data.weight || 999;
  return weight >= 30 && weight < 50;
});
const metadataConcepts: CollectionEntry<'docs'>[] = concepts.filter(d => {
  const weight = d.data.weight || 999;
  return weight >= 40 && weight < 50;
});
const governanceConcepts: CollectionEntry<'docs'>[] = concepts.filter(d => {
  const weight = d.data.weight || 999;
  return weight >= 50 && weight < 60;
});
const advancedFeatures: CollectionEntry<'docs'>[] = concepts.filter(d => {
  const weight = d.data.weight || 999;
  return weight >= 60;
});

// Reference subfolder
const referenceDocs: CollectionEntry<'docs'>[] = sortedDocs.filter((d: CollectionEntry<'docs'>) => d.slug.startsWith('reference/'));
---

<Layout title="Documentation" description="Complete Sruja documentation and guides.">
  <ContentPage title="Documentation" summary="Complete documentation for Sruja, including guides, concepts, and reference materials.">
    <div class="docs-index">
      
      <!-- Getting Started -->
      {gettingStarted.length > 0 && (
        <section class="docs-section">
          <h2 class="section-title">Getting Started</h2>
          <p class="section-description">Start here to learn the basics of Sruja</p>
          <div class="docs-grid">
            {gettingStarted.map((doc) => {
              const item = transformToContentListItem(doc, '/docs', { linkText: 'Read More →' });
              return (
                <a href={item.href} class="doc-card">
                  <h3 class="doc-card-title">{item.title}</h3>
                  {item.summary && <p class="doc-card-summary">{item.summary}</p>}
                </a>
              );
            })}
          </div>
        </section>
      )}

      <!-- Concepts -->
      {concepts.length > 0 && (
        <section class="docs-section">
          <h2 class="section-title">Concepts</h2>
          <p class="section-description">Core concepts and building blocks of Sruja</p>
          <div class="concepts-grid">
            {coreConcepts.length > 0 && (
              <ExpandableCard 
                title="Core Concepts" 
                summary={`${coreConcepts.length} concepts`}
                id="core-concepts"
              >
                <div class="concept-links">
                  {coreConcepts.map((doc) => (
                    <a href={`/docs/${doc.slug}`} class="concept-link">{doc.data.title}</a>
                  ))}
                </div>
              </ExpandableCard>
            )}
            {relationsConcepts.length > 0 && (
              <ExpandableCard 
                title="Relations & Behavior" 
                summary={`${relationsConcepts.length} concepts`}
                id="relations-concepts"
              >
                <div class="concept-links">
                  {relationsConcepts.map((doc) => (
                    <a href={`/docs/${doc.slug}`} class="concept-link">{doc.data.title}</a>
                  ))}
                </div>
              </ExpandableCard>
            )}
            {advancedConcepts.length > 0 && (
              <ExpandableCard 
                title="Advanced Concepts" 
                summary={`${advancedConcepts.length} concepts`}
                id="advanced-concepts"
              >
                <div class="concept-links">
                  {advancedConcepts.map((doc) => (
                    <a href={`/docs/${doc.slug}`} class="concept-link">{doc.data.title}</a>
                  ))}
                </div>
              </ExpandableCard>
            )}
            {metadataConcepts.length > 0 && (
              <ExpandableCard 
                title="Metadata & Configuration" 
                summary={`${metadataConcepts.length} concepts`}
                id="metadata-concepts"
              >
                <div class="concept-links">
                  {metadataConcepts.map((doc) => (
                    <a href={`/docs/${doc.slug}`} class="concept-link">{doc.data.title}</a>
                  ))}
                </div>
              </ExpandableCard>
            )}
            {governanceConcepts.length > 0 && (
              <ExpandableCard 
                title="Governance & Policy" 
                summary={`${governanceConcepts.length} concepts`}
                id="governance-concepts"
              >
                <div class="concept-links">
                  {governanceConcepts.map((doc) => (
                    <a href={`/docs/${doc.slug}`} class="concept-link">{doc.data.title}</a>
                  ))}
                </div>
              </ExpandableCard>
            )}
            {advancedFeatures.length > 0 && (
              <ExpandableCard 
                title="Advanced Features" 
                summary={`${advancedFeatures.length} concepts`}
                id="advanced-features"
              >
                <div class="concept-links">
                  {advancedFeatures.map((doc) => (
                    <a href={`/docs/${doc.slug}`} class="concept-link">{doc.data.title}</a>
                  ))}
                </div>
              </ExpandableCard>
            )}
          </div>
        </section>
      )}

      <!-- Guides -->
      {guides.length > 0 && (
        <section class="docs-section">
          <h2 class="section-title">Guides</h2>
          <p class="section-description">Step-by-step guides for adoption and decision-making</p>
          <div class="docs-grid">
            {guides.map((doc) => {
              const item = transformToContentListItem(doc, '/docs', { linkText: 'Read More →' });
              return (
                <a href={item.href} class="doc-card">
                  <h3 class="doc-card-title">{item.title}</h3>
                  {item.summary && <p class="doc-card-summary">{item.summary}</p>}
                </a>
              );
            })}
          </div>
        </section>
      )}

      <!-- Reference -->
      {(reference.length > 0 || referenceDocs.length > 0) && (
        <section class="docs-section">
          <h2 class="section-title">Reference</h2>
          <p class="section-description">CLI commands, syntax, and quick reference materials</p>
          <div class="docs-grid">
            {reference.map((doc) => {
              const item = transformToContentListItem(doc, '/docs', { linkText: 'Read More →' });
              return (
                <a href={item.href} class="doc-card">
                  <h3 class="doc-card-title">{item.title}</h3>
                  {item.summary && <p class="doc-card-summary">{item.summary}</p>}
                </a>
              );
            })}
            {referenceDocs.map((doc) => {
              const item = transformToContentListItem(doc, '/docs', { linkText: 'Read More →' });
              return (
                <a href={item.href} class="doc-card">
                  <h3 class="doc-card-title">{item.title}</h3>
                  {item.summary && <p class="doc-card-summary">{item.summary}</p>}
                </a>
              );
            })}
          </div>
        </section>
      )}

      <!-- Examples -->
      {examples.length > 0 && (
        <section class="docs-section">
          <h2 class="section-title">Examples</h2>
          <p class="section-description">Real-world examples and use cases</p>
          <div class="docs-grid">
            {examples.map((doc) => {
              const item = transformToContentListItem(doc, '/docs', { linkText: 'Read More →' });
              return (
                <a href={item.href} class="doc-card">
                  <h3 class="doc-card-title">{item.title}</h3>
                  {item.summary && <p class="doc-card-summary">{item.summary}</p>}
                </a>
              );
            })}
          </div>
        </section>
      )}

      <!-- Community -->
      {community.length > 0 && (
        <section class="docs-section">
          <h2 class="section-title">Community</h2>
          <p class="section-description">Join the community and contribute</p>
          <div class="docs-grid">
            {community.map((doc) => {
              const item = transformToContentListItem(doc, '/docs', { linkText: 'Read More →' });
              return (
                <a href={item.href} class="doc-card">
                  <h3 class="doc-card-title">{item.title}</h3>
                  {item.summary && <p class="doc-card-summary">{item.summary}</p>}
                </a>
              );
            })}
          </div>
        </section>
      )}

      <!-- Style Guide -->
      {styleGuide.length > 0 && (
        <section class="docs-section">
          <h2 class="section-title">Style Guide</h2>
          <p class="section-description">Documentation standards and best practices</p>
          <div class="docs-grid">
            {styleGuide.map((doc) => {
              const item = transformToContentListItem(doc, '/docs', { linkText: 'Read More →' });
              return (
                <a href={item.href} class="doc-card">
                  <h3 class="doc-card-title">{item.title}</h3>
                  {item.summary && <p class="doc-card-summary">{item.summary}</p>}
                </a>
              );
            })}
          </div>
        </section>
      )}

    </div>
  </ContentPage>
</Layout>

<style>
  .docs-index {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .docs-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.25rem 0;
    color: var(--color-text-primary, #0f172a);
  }

  :global(html.dark) .section-title {
    color: #f1f5f9;
  }

  .section-description {
    font-size: 0.9375rem;
    color: var(--color-text-secondary, #64748b);
    margin: 0 0 1rem 0;
    line-height: 1.4;
  }

  :global(html.dark) .section-description {
    color: #cbd5e1;
  }

  .docs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1rem;
  }

  .doc-card {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1.25rem;
    border: 1px solid var(--color-border, #e2e8f0);
    border-radius: 0.5rem;
    background: var(--color-background, #ffffff);
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
  }

  :global(html.dark) .doc-card {
    border-color: #334155;
    background: #1e293b;
  }

  .doc-card:hover {
    border-color: var(--color-primary, #3b82f6);
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }

  :global(html.dark) .doc-card:hover {
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.3);
  }

  .doc-card-title {
    font-size: 1.0625rem;
    font-weight: 600;
    margin: 0;
    color: var(--color-text-primary, #0f172a);
    line-height: 1.3;
  }

  :global(html.dark) .doc-card-title {
    color: #f1f5f9;
  }

  .doc-card-summary {
    font-size: 0.875rem;
    color: var(--color-text-secondary, #64748b);
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  :global(html.dark) .doc-card-summary {
    color: #cbd5e1;
  }

  /* Concepts Section */
  .concepts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  .concept-links {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .concept-link {
    font-size: 0.875rem;
    color: var(--color-primary, #3b82f6);
    text-decoration: none;
    transition: color 0.2s;
    padding: 0.25rem 0;
    line-height: 1.4;
  }

  .concept-link:hover {
    color: var(--color-primary-hover, #2563eb);
    text-decoration: underline;
  }

  @media (max-width: 1024px) {
    .docs-grid {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 0.875rem;
    }

    .concepts-grid {
      grid-template-columns: 1fr;
      gap: 0.875rem;
    }
  }

  @media (max-width: 768px) {
    .docs-index {
      gap: 1.75rem;
    }

    .docs-section {
      gap: 0.875rem;
    }

    .section-title {
      font-size: 1.375rem;
    }

    .section-description {
      font-size: 0.875rem;
      margin-bottom: 0.875rem;
    }

    .docs-grid {
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .doc-card {
      padding: 1rem;
    }

    .concept-groups {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

  }

  @media (min-width: 1400px) {
    .docs-grid {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }

    .concept-groups {
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
  }
</style>
