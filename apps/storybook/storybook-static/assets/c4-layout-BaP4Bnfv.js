import{j as M}from"./iframe-CLHqt8sP.js";function W({result:t,width:n=1200,height:e=800}){return M.jsxs("svg",{width:n,height:e,viewBox:`0 0 ${n} ${e}`,style:{background:"#fff",border:"1px solid #eee"},children:[Array.from(t.nodes.values()).map(o=>M.jsxs("g",{children:[M.jsx("rect",{x:o.bbox.x,y:o.bbox.y,width:o.bbox.width,height:o.bbox.height,rx:8,ry:8,fill:"#f7f7f7",stroke:"#333"}),M.jsx("text",{x:o.bbox.x+8,y:o.bbox.y+20,fontSize:14,fill:"#111",children:o.nodeId})]},o.nodeId)),t.relationships.map(o=>M.jsx("g",{children:o.controlPoints?M.jsx("path",{d:q(o),fill:"none",stroke:"#1e6fff",strokeWidth:2}):o.points.slice(1).map((i,r)=>{const c=o.points[r];return M.jsx("line",{x1:c.x,y1:c.y,x2:i.x,y2:i.y,stroke:"#1e6fff",strokeWidth:2},r)})},o.relationshipId))]})}function q(t){const[n,e]=t.points,[o,i]=t.controlPoints||[n,e];return`M ${n.x} ${n.y} C ${o.x} ${o.y}, ${i.x} ${i.y}, ${e.x} ${e.y}`}W.__docgenInfo={description:"",methods:[],displayName:"LayoutSVG",props:{result:{required:!0,tsType:{name:"C4LayoutResult"},description:""},width:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"1200",computed:!1}},height:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"800",computed:!1}}}};class I extends Error{code;constructor(n,e){super(e),this.code=n,this.name="ValidationError"}}function Ce(t){if(!t||t.trim().length===0)throw new I("E003","C4Id cannot be empty");if(!/^[a-zA-Z][a-zA-Z0-9_-]*$/.test(t))throw new I("E004",`C4Id must start with letter and contain only alphanumeric, hyphens, underscores: "${t}"`);return t}function Ie(t,n,e){const o=new Map,i=[];for(const r of t)o.has(r.id)&&i.push(new I("E003",`Duplicate node ID: "${r.id}"`)),o.set(r.id,r);for(const r of t)r.parentId&&!o.has(r.parentId)&&i.push(new I("E002",`Node "${r.id}" references non-existent parent "${r.parentId}"`));for(const r of n)o.has(r.from)||i.push(new I("E004",`Relationship "${r.id}" references non-existent source "${r.from}"`)),o.has(r.to)||i.push(new I("E004",`Relationship "${r.id}" references non-existent target "${r.to}"`));if(i.length>0)throw i;return{nodes:o,relationships:n,metadata:e}}function Q(t,n){return(!n.includeTags||A(t.tags,n.includeTags))&&(!n.includeKinds||n.includeKinds.has(t.kind))&&(!n.includeNodes||n.includeNodes.has(t.id))?!(n.excludeTags&&A(t.tags,n.excludeTags)||n.excludeKinds&&n.excludeKinds.has(t.kind)||n.excludeNodes&&n.excludeNodes.has(t.id)):!1}function A(t,n){for(const e of t)if(n.has(e))return!0;return!1}function ve(t){return{collapsedNodeIds:new Set,hiddenNodeIds:new Set,expandedLevels:new Set(["context"]),focusNodeId:t,focusRadius:1,layoutPreset:"interactive",direction:"TB",alignment:"center",filter:{includeKinds:new Set(["Person","SoftwareSystem","ExternalSystem"])}}}function De(t){return{collapsedNodeIds:new Set,hiddenNodeIds:new Set,expandedLevels:new Set(["context","container"]),focusNodeId:t,focusRadius:2,layoutPreset:"interactive",direction:"TB",alignment:"center",filter:{includeKinds:new Set(["Person","SoftwareSystem","Container","Database","Queue","Cache"])}}}function Pe(t){return{collapsedNodeIds:new Set,hiddenNodeIds:new Set,expandedLevels:new Set(["container","component"]),focusNodeId:t,focusRadius:2,layoutPreset:"interactive",direction:"TB",alignment:"center",filter:{includeKinds:new Set(["Container","Component","Database","Queue","Cache"])}}}function ze(t){return{collapsedNodeIds:new Set,hiddenNodeIds:new Set,expandedLevels:new Set(["deployment"]),layoutPreset:"presentation",direction:"LR",alignment:"start",filter:{includeTags:new Set([t,"infrastructure"]),includeKinds:new Set(["DeploymentNode","Container","Database","Queue","DeploymentGroup"])}}}function U(t,n){const e=new Map;for(const[s,a]of t.nodes)n.hiddenNodeIds.has(s)||a.hidden||n.filter&&!Q(a,n.filter)||e.set(s,{id:s,node:a,parent:void 0,children:[],depth:0,subtreeSize:1,subtreeDepth:0});const o=[];for(const[s,a]of e){const h=a.node.parentId;if(h&&e.has(h)){const d=e.get(h);a.parent=d,d.children.push(a)}else o.push(a)}function i(s,a){if(s.depth=a,s.children.length===0)return s.subtreeSize=1,s.subtreeDepth=0,{size:1,maxDepth:a};let h=1,d=a;for(const u of s.children){const l=i(u,a+1);h+=l.size,d=Math.max(d,l.maxDepth)}return s.subtreeSize=h,s.subtreeDepth=d-a,{size:h,maxDepth:d}}let r=0;for(const s of o){const a=i(s,0);r=Math.max(r,a.maxDepth)}function c(s){s.children.sort((a,h)=>{const d=a.node.layoutPriority??50,u=h.node.layoutPriority??50;if(d!==u)return u-d;const l=a.node.sortKey??a.node.label,x=h.node.sortKey??h.node.label;return l.localeCompare(x)});for(const a of s.children)c(a)}o.sort((s,a)=>{const h=s.node.layoutPriority??50,d=a.node.layoutPriority??50;if(h!==d)return d-h;const u=s.node.sortKey??s.node.label,l=a.node.sortKey??a.node.label;return u.localeCompare(l)});for(const s of o)c(s);return{roots:o,nodeMap:e,maxDepth:r}}function Z(t,n,e,o){const i=t.split(/\s+/).filter(Boolean),r=[],c=[];let s="",a=0;const h=e.measureLine("A",n).lineHeight;for(const d of i){const u=s?s+" "+d:d,l=e.measureLine(u,n).width;l>o&&s?(r.push(s),c.push(a),s=d,a=e.measureLine(s,n).width):(s=u,a=l)}return s&&(r.push(s),c.push(a)),{lines:r,widths:c,lineHeight:h}}function J(t,n,e,o,i){const r=Z(t,n,e,o),c=Math.max(...r.widths),s=r.lines.length*r.lineHeight;return{width:c+i.padding*2,height:s+i.padding*2}}const ee={padding:16};function te(t,n,e=4){const o=new Map,i=new Map;function r(s){if(i.has(s.id))return i.get(s.id);const a=s.parent?r(s.parent)+1:0;i.set(s.id,a);const h=o.get(a)??[];return h.push(s.id),o.set(a,h),a}for(const s of t.values())r(s);for(let s=0;s<e;s++){for(let a=1;a<o.size;a++)O(a,o,n,t,!0);for(let a=o.size-2;a>=0;a--)O(a,o,n,t,!1)}const c=new Map;for(const[s,a]of o)a.forEach((h,d)=>{const u=t.get(h);c.set(h,{...u,layer:s,order:d})});return c}function O(t,n,e,o,i){const r=n.get(t),c=n.get(i?t-1:t+1);if(!c)return;const s=new Map;c.forEach((h,d)=>s.set(h,d));const a=[];for(const h of r){const d=o.get(h),u=[];d.parent&&s.has(d.parent.id)&&u.push(s.get(d.parent.id));for(const x of e)x.from===h&&s.has(x.to)&&u.push(s.get(x.to)),x.to===h&&s.has(x.from)&&u.push(s.get(x.from));const l=u.length?u.reduce((x,y)=>x+y,0)/u.length:r.indexOf(h);a.push({id:h,bc:l})}a.sort((h,d)=>h.bc-d.bc),n.set(t,a.map(h=>h.id))}function ne(t,n=1200,e=40,o=30,i=60){const r=new Map,c=new Map;for(const d of t.values()){const u=c.get(d.layer)??[];u.push(d),c.set(d.layer,u)}const s=[...c.keys()].sort((d,u)=>d-u);let a=e;const h=new Map;for(const d of s){h.set(d,a);const u=Math.max(...c.get(d).map(l=>l.size.height));a+=u+i}for(const d of s){const u=c.get(d).sort((y,g)=>y.order-g.order),l=u.reduce((y,g)=>y+g.size.width,0)+o*(u.length-1);let x=(n-l)/2;for(const y of u){const g={...y,x,y:h.get(d),bbox:{x,y:h.get(d),width:y.size.width,height:y.size.height}};r.set(y.id,g),x+=y.size.width+o}}return r}function j(t,n){const e={x:t.x+t.width/2,y:t.y+t.height/2},o={x:n.x+n.width/2,y:n.y+n.height/2},i=o.x-e.x,r=o.y-e.y;return Math.abs(i)>Math.abs(r)?i>0?{side:"east",position:{x:t.x+t.width,y:e.y},angle:0}:{side:"west",position:{x:t.x,y:e.y},angle:180}:r>0?{side:"south",position:{x:e.x,y:t.y+t.height},angle:90}:{side:"north",position:{x:e.x,y:t.y},angle:270}}function oe(t,n){const e=[t.position],o=t.position.x,i=t.position.y,r=n.position.x,c=n.position.y;if(t.side==="south"||t.side==="north"){const s=(i+c)/2;o!==r&&(e.push({x:o,y:s}),e.push({x:r,y:s}))}else{const s=(o+r)/2;i!==c&&(e.push({x:s,y:i}),e.push({x:s,y:c}))}return e.push(n.position),e}function se(t,n,e,o=50){let i=oe(t,n),r=0;for(let c=1;c<i.length&&r<o;c++){const s=i[c-1],a=i[c],h=ie(s,a,e);if(h){const d=ae(s,a,h);i=[...i.slice(0,c),...d,...i.slice(c)],c+=d.length,r++}}return i}function ie(t,n,e){for(const o of e)if(re(t,n,o))return o}function re(t,n,e){const o=r=>r>=e.x&&r<=e.x+e.width,i=r=>r>=e.y&&r<=e.y+e.height;if(t.x===n.x){const r=t.x,c=Math.min(t.y,n.y),s=Math.max(t.y,n.y);return o(r)&&!(s<e.y||c>e.y+e.height)}else if(t.y===n.y){const r=t.y,c=Math.min(t.x,n.x),s=Math.max(t.x,n.x);return i(r)&&!(s<e.x||c>e.x+e.width)}return!1}function ae(t,n,e){const i={x:e.x-6,y:t.y},r={x:e.x+e.width+6,y:t.y},c={x:t.x,y:e.y-6},s={x:t.x,y:e.y+e.height+6},a=[[i,{x:i.x,y:n.y}],[r,{x:r.x,y:n.y}],[c,{x:n.x,y:c.y}],[s,{x:n.x,y:s.y}]];let h=a[0],d=z([t,...h,n]);for(const u of a.slice(1)){const l=z([t,...u,n]);l<d&&(h=u,d=l)}return h}function z(t){let n=0;for(let e=1;e<t.length;e++)n+=Math.hypot(t[e].x-t[e-1].x,t[e].y-t[e-1].y);return n}function K(t){const n=z(t)/2;let e=0;for(let o=1;o<t.length;o++){const i=Math.hypot(t[o].x-t[o-1].x,t[o].y-t[o-1].y);if(e+i>=n){const r=(n-e)/i;return{x:t[o-1].x+(t[o].x-t[o-1].x)*r,y:t[o-1].y+(t[o].y-t[o-1].y)*r}}e+=i}return t[Math.floor(t.length/2)]}function V(t,n){return Math.atan2(n.y-t.y,n.x-t.x)*180/Math.PI}function ce(t,n){const e=t.position,o=n.position,i=o.x-e.x,r=o.y-e.y,c=.3;let s,a;return t.side==="east"||t.side==="west"?(s={x:e.x+i*c,y:e.y},a={x:o.x-i*c,y:o.y}):(s={x:e.x,y:e.y+r*c},a={x:o.x,y:o.y-r*c}),{points:[e,o],controlPoints:[s,a]}}function de(t,n){let e=1/0,o=1/0,i=-1/0,r=-1/0;for(const l of t.values())e=Math.min(e,l.x),o=Math.min(o,l.y),i=Math.max(i,l.x+l.size.width),r=Math.max(r,l.y+l.size.height);const c={width:i-e,height:r-o};let s=0;for(const l of t.values())s+=l.size.width*l.size.height;const a=s/(c.width*c.height||1);let h=0;for(let l=0;l<n.length;l++)for(let x=l+1;x<n.length;x++)he(n[l].points,n[x].points)&&h++;const d=n.reduce((l,x)=>l+x.bendCount,0),u=n.reduce((l,x)=>l+x.length,0);return{aspectRatio:c.width/(c.height||1),coverage:a,edgeCrossings:h,edgeBends:d,totalEdgeLength:u,uniformity:1,balance:1,compactness:a}}function he(t,n){for(let e=1;e<t.length;e++)for(let o=1;o<n.length;o++)if(le(t[e-1],t[e],n[o-1],n[o]))return!0;return!1}function le(t,n,e,o){function i(r,c,s){return(s.y-r.y)*(c.x-r.x)>(c.y-r.y)*(s.x-r.x)}return i(t,e,o)!==i(n,e,o)&&i(t,n,e)!==i(t,n,o)}const ue={fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',fontSize:{Person:14,SoftwareSystem:16,Container:14,Component:12,Database:14,landscape:18,context:16,container:14,component:12,deployment:14},fontWeight:{Person:"bold",SoftwareSystem:"bold",Container:"600",Component:"normal",Database:"600"},padding:{Person:16,SoftwareSystem:24,Container:20,Component:12,Database:16},margin:{Person:20,SoftwareSystem:30,Container:20,Component:15,Database:20},textColor:"#1a1a1a",backgroundColor:"#ffffff"};class fe{canvas;ctx;_fallbackFont="14px system-ui";constructor(){try{typeof document<"u"?(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")):typeof OffscreenCanvas<"u"&&(this.canvas=new OffscreenCanvas(1,1),this.ctx=this.canvas.getContext("2d"))}catch{this.canvas=void 0,this.ctx=void 0}}setFont(n,e){const i=`${this.getLineHeight(n,e)-4}px system-ui`;this.ctx&&"font"in this.ctx&&(this.ctx.font=i)}measure(n,e,o,i){if(this.ctx){this.setFont(e,o);const r=this.ctx.measureText(n),c=r.actualBoundingBoxAscent??0,s=r.actualBoundingBoxDescent??0,a=c+s||this.getLineHeight(e,o);return{width:r.width||n.length*8,height:a}}return{width:n.length*8,height:this.getLineHeight(e,o)}}measureMultiline(n,e,o,i){const r=n.split(/\s+/).filter(Boolean),c=[];let s="",a=0;const h=this.getLineHeight(e,o);for(const d of r){const u=s?s+" "+d:d;this.measure(u,e,o).width>i&&s?(c.push(s),a=Math.max(a,this.measure(s,e,o).width),s=d):s=u}return s&&(c.push(s),a=Math.max(a,this.measure(s,e,o).width)),{width:a,height:c.length*h,lines:c}}getLineHeight(n,e){return 18}getDescent(n,e){return 4}}class xe{base;cache=new Map;constructor(n){this.base=n}key(n,e,o,i){return`${e}:${o}:${i??""}:${n}`}measure(n,e,o,i){const r=this.key(n,e,o,i),c=this.cache.get(r);if(c)return{width:c.width,height:c.height};const s=this.base.measure(n,e,o,i);return this.cache.set(r,s),s}measureMultiline(n,e,o,i){const r=pe(n),c=this.key(r,e,o,i),s=this.cache.get(c);if(s&&s.lines)return{width:s.width,height:s.height,lines:s.lines};const a=this.base.measureMultiline(r,e,o,i);return this.cache.set(c,a),a}getLineHeight(n,e){return this.base.getLineHeight(n,e)}getDescent(n,e){return this.base.getDescent(n,e)}}function pe(t){return t.replace(/([a-z]{6,})/gi,n=>n.slice(0,Math.floor(n.length/2))+"-"+n.slice(Math.floor(n.length/2)))}const R={direction:"TB",alignment:"center",spacing:{node:{SoftwareSystem:24},rank:{Container:60},padding:{SoftwareSystem:24,Container:16},port:10},minSize:{width:80,height:40},maxSize:{width:800,height:600},aspectRatioLimits:{min:1,max:2},edgeRouting:{algorithm:"orthogonal",bendPenalty:1,crossingPenalty:10,segmentLength:20,avoidNodes:!0,preferOrthogonal:!0},overlapRemoval:{enabled:!0,algorithm:"shift",iterations:10,tolerance:1,padding:8},beautify:{alignNodes:!0,straightenEdges:!0,balanceTree:!0,compactGroups:!0,removeOverlaps:!0},maxIterations:10,tolerance:.01,useGPU:!1,measurer:new xe(new fe),theme:ue},ye={...R,spacing:{node:{SoftwareSystem:30},rank:{Container:80},padding:{SoftwareSystem:28,Container:20},port:12}},Le={...R,spacing:{node:{SoftwareSystem:40},rank:{Container:100},padding:{SoftwareSystem:32,Container:24},port:14}},ke={...R,spacing:{node:{SoftwareSystem:16},rank:{Container:40},padding:{SoftwareSystem:16,Container:12},port:8}};function ge(t,n={}){const e=n.gridSize??20;if(!!n.snapToGrid)for(const i of t.values())i.x=Math.round(i.x/e)*e,i.y=Math.round(i.y/e)*e,i.bbox.x=i.x,i.bbox.y=i.y;return t}function me(t,n=8,e=10){const o=[...t.values()];for(let r=0;r<e;r++){let c=!1;for(let s=0;s<o.length;s++)for(let a=s+1;a<o.length;a++){const h=o[s],d=o[a];if(be(h.bbox,d.bbox,n)){const u=h.bbox.x+h.bbox.width/2-(d.bbox.x+d.bbox.width/2),l=h.bbox.y+h.bbox.height/2-(d.bbox.y+d.bbox.height/2),x=Math.sign(u)*Math.max(1,Math.abs(u)/10),y=Math.sign(l)*Math.max(1,Math.abs(l)/10);h.x+=x,h.y+=y,d.x-=x,d.y-=y,h.bbox.x=h.x,h.bbox.y=h.y,d.bbox.x=d.x,d.bbox.y=d.y,c=!0}}if(!c)break}const i=new Map;for(const r of o)i.set(r.id,r);return i}function be(t,n,e){return!(t.x+t.width+e<n.x||n.x+n.width+e<t.x||t.y+t.height+e<n.y||n.y+n.height+e<t.y)}const we=[];function Se(t,n){for(const e of we)e(t,n)}function Te(t,n,e=ye){const o=Date.now(),i=[],r=Date.now(),c=U(t,n);i.push({name:"buildHierarchy",durationMs:Date.now()-r,nodesProcessed:c.nodeMap.size});const s=Date.now(),a=new Map;for(const f of c.nodeMap.values()){const p=f.node.label,w={fontFamily:e.theme.fontFamily,fontSize:e.theme.fontSize[f.node.kind]??14},T=J(p,w,{measureLine:P=>({text:P,width:P.length*8,lineHeight:18})},300,ee);a.set(f.id,{...f,size:T})}i.push({name:"calculateSizes",durationMs:Date.now()-s,nodesProcessed:a.size});const h=Date.now(),d=te(a,t.relationships.map(f=>({from:f.from,to:f.to})));i.push({name:"assignLayersAndOrder",durationMs:Date.now()-h,nodesProcessed:d.size});const u=Date.now(),l=e.spacing.padding.SoftwareSystem??40,x=e.spacing.node.SoftwareSystem??30,y=e.spacing.rank.Container??60;let g=ne(d,1200,l,x,y);if(i.push({name:"assignCoordinates",durationMs:Date.now()-u,nodesProcessed:g.size}),e.overlapRemoval.enabled){const f=Date.now();g=me(g,e.overlapRemoval.padding,e.overlapRemoval.iterations),i.push({name:"removeOverlaps",durationMs:Date.now()-f,nodesProcessed:g.size})}const Y=Date.now(),C=[];for(const f of t.relationships){const p=g.get(f.from),w=g.get(f.to);if(!p||!w)continue;const T=j(p.bbox,w.bbox),P=j(w.bbox,p.bbox),H=f.preferredRoute??e.edgeRouting.algorithm;if(H==="curved"||H==="splines"){const{points:b,controlPoints:m}=ce(T,P),S=K([b[0],b[1]]),B=V(b[0],b[1]);C.push({relationshipId:f.id,sourceId:f.from,targetId:f.to,points:b,controlPoints:m,segmentTypes:["arc"],labelPosition:S,labelAngle:0,labelBounds:{x:S.x-50,y:S.y-10,width:100,height:20},arrowEnd:b[b.length-1],arrowAngle:B,length:z(b),bendCount:0,crossesBoundaries:!1})}else{const b=[...g.values()].filter(N=>N.id!==p.id&&N.id!==w.id).map(N=>N.bbox),m=se(T,P,b),S=K(m),B=V(m[m.length-2]??m[0],m[m.length-1]);C.push({relationshipId:f.id,sourceId:f.from,targetId:f.to,points:m,segmentTypes:m.slice(1).map(()=>"orthogonal"),labelPosition:S,labelAngle:0,labelBounds:{x:S.x-50,y:S.y-10,width:100,height:20},arrowEnd:m[m.length-1],arrowAngle:B,length:z(m),bendCount:m.length-2,crossesBoundaries:!1})}}i.push({name:"routeEdges",durationMs:Date.now()-Y,nodesProcessed:C.length});const v=new Map;for(const[f,p]of g)v.set(f,{nodeId:f,bbox:p.bbox,contentBox:p.bbox,labelBox:p.bbox,parentId:p.parent?.id,childrenIds:p.children.map(w=>w.id),depth:p.depth,level:p.node.level,collapsed:!!p.node.collapseChildren,visible:!p.node.hidden,zIndex:0,ports:[]});const _=Date.now();ge(new Map([...g]),{alignNodes:e.beautify.alignNodes,gridSize:n.gridSize,snapToGrid:n.snapToGrid}),Se(v,C),i.push({name:"beautify",durationMs:Date.now()-_,nodesProcessed:g.size});let L=1/0,k=1/0,$=-1/0,E=-1/0;for(const f of v.values())L=Math.min(L,f.bbox.x),k=Math.min(k,f.bbox.y),$=Math.max($,f.bbox.x+f.bbox.width),E=Math.max(E,f.bbox.y+f.bbox.height);const D={x:L,y:k,width:$-L,height:E-k},G={x:D.x+D.width/2,y:D.y+D.height/2},X=de(new Map([...v].map(([f,p])=>[f,{x:p.bbox.x,y:p.bbox.y,size:{width:p.bbox.width,height:p.bbox.height}}])),C.map(f=>({...f,points:[...f.points]}))),F=Date.now();return{nodes:v,relationships:C,bbox:D,center:G,metrics:X,debug:{layoutTimeMs:F-o,phases:i,warnings:[]}}}export{De as C,ze as D,ye as I,W as L,R as P,ve as S,Ie as a,Le as b,Ce as c,ke as d,Pe as e,Te as l};
