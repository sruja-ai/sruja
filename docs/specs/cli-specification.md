# Architecture CLI v1 Specification

**Official CLI Specification**

**Status:** Draft (for post-MVP implementation)  
**Version:** `CLI-1.0`

Cross-platform CLI tool that works with Architecture Project Format v1 (APF-1.0).

---

## üéØ Overview

The CLI provides command-line access to architecture modeling, mirroring tools like Terraform, Prettier, and ESLint.

**Installation:**
```bash
go install github.com/sruja-ai/sruja/cmd/sruja@latest
```

**Commands:**
- `arch init` - Create new architecture project
- `arch compile` - Compile DSL to JSON model
- `arch validate` - Validate architecture syntax and semantics

---

## üèó CLI Architecture

```
sruja
 ‚îÇ
 ‚îú‚îÄ‚îÄ init       (create project structure)
 ‚îú‚îÄ‚îÄ compile    (DSL ‚Üí JSON model)
 ‚îî‚îÄ‚îÄ validate   (semantic & structural checks)
```

**Internal Components:**
- Ohm grammar ‚Üí parser
- AST builder
- Zod schema validator
- Semantic rules engine
- Project loader (uses ProjectProvider)
- File writer
- Error reporter

**Design Principle**: Everything is **pure functions** ‚Üí no DB, no HTTP, no cloud dependencies.

---

## ‚öôÔ∏è Command: `sruja init`

Create a fresh APF v1 project in the current directory.

### Usage

```bash
sruja init
sruja init my-architecture
```

### Behavior

- Creates folder + APF structure (if path provided)
- Writes a starter `architecture.sruja`
- Writes `.architecture/config.json`
- Writes `.architecture/.gitignore` (for cache)
- Creates optional directories (`adrs`, `journeys`, etc.)
- Prints next steps

### Generated Structure

```
architecture.sruja
.architecture/
   config.json
   model.json
   index.json        # generated by LSP (gitignored)
adrs/
.gitignore
```

### Template Example: architecture.sruja

```dsl
system "New System" {
  container api: Service "API Gateway" {
    component example: Component "Example Component"
  }
}
```

### Flags

| Flag                | Description                                |
| ------------------- | ------------------------------------------ |
| `--minimal`         | Only `architecture.sruja` + `.architecture/` |
| `--force`           | Overwrite existing files                   |
| `--template <path>` | Init from a custom template repo           |

### Exit Codes

| Code | Meaning                            |
| ---- | ---------------------------------- |
| 0    | Success                            |
| 1    | Directory not empty (no `--force`) |
| 2    | Filesystem error                   |

---

## ‚öôÔ∏è Command: `sruja compile`

Compile the DSL files into the canonical **JSON model**.

### Usage

```bash
sruja compile
sruja compile architecture.sruja
sruja compile --output model.json
```

### Behavior

- Loads project structure
- Parses `architecture.sruja` (or specified file)
- Resolves imports
- Builds AST (Go, participle)
- Normalizes to internal model
- Writes `.architecture/model.json`
- Generates `.architecture/index.json` (optional, gitignored)
- Leaves `.architecture/visual.json` untouched

### Input

- Default: `./architecture.sruja`
- Accepts any `*.sruja` file if path provided

### Output

**Default:**
```
.architecture/model.json
.architecture/index.json
```

**Override:**
```bash
sruja compile --output ./tmp/compiled.json
```

### Common Errors

- Syntax errors
- Unknown types
- Duplicate IDs
- Missing referenced nodes
- Invalid metadata
- Import resolution failure

### Flags

| Flag              | Description                   |
| ----------------- | ----------------------------- |
| `--watch`         | Recompile on file change      |
| `--output <file>` | Write compiled JSON elsewhere |
| `--pretty`        | Pretty-print JSON             |
| `--silent`        | No terminal output            |
| `--strict`        | Treat warnings as errors      |

### Exit Codes

| Code | Meaning            |
| ---- | ------------------ |
| 0    | Success            |
| 1    | Syntax errors      |
| 2    | Semantic errors    |
| 3    | Output write error |

---

## ‚öôÔ∏è Command: `sruja create-plugin`

Generate a new validation plugin from a template.

### Usage

```bash
sruja create-plugin <name>
sruja create-plugin pci-security
sruja create-plugin my-plugin --yes --git --install
```

### Behavior

- Creates complete plugin structure
- Prompts for metadata (unless `--yes`)
- Generates all necessary files
- Optionally initializes git repo
- Optionally installs dependencies

### Flags

| Flag                      | Description                           |
| ------------------------- | ------------------------------------- |
| `--dir <path>`            | Generate in custom directory          |
| `--yes`                   | Skip all prompts                      |
| `--template <github-url>` | Support remote templates (future)      |
| `--git`                   | Auto init git repo                    |
| `--install`               | Auto install deps                    |

### Example

```bash
$ sruja create-plugin pci-security

üß© Creating plugin: pci-security

Description: PCI DSS compliance rules
Author: Dilip Kola
Version: 0.1.0

‚úÖ Plugin created at pci-security

Next steps:

  cd pci-security
  bun install
  bun run dev
```

See [Plugin Generator](./plugin-generator.md) for complete implementation details.

---

## ‚öôÔ∏è Command: `sruja validate`

Validates architecture based on syntax, semantics, and best practices.

### Validation Types

#### 1. Syntax Validation
Handled by parsing DSL (Ohm grammar).

#### 2. Semantic Validation
- No missing references
- No orphan nodes
- Correct layer rules
- Circular dependency detection
- Required metadata present
- Invalid relationships
- Naming conventions
- Duplicate definitions

#### 3. Best Practice Rules (basic in v1)
- External systems must not depend on internal ones
- Components must belong to containers
- Containers should belong to systems

#### 4. Plugin-Based Validators (future-ready)
```json
{
  "validation": {
    "strictLayers": true,
    "plugins": ["zero-trust", "cloud-standards"]
  }
}
```

### Usage

```bash
sruja validate
```

### Behavior

- Runs `compile` in-memory
- Checks `model.json` and DSL directly
- Prints errors/warnings
- Non-zero exit code on errors

### CLI Output Format Example

```
‚úî Syntax OK
‚úî All imports resolved
‚úñ 2 semantic issues
  - Unknown reference: api -> datastore: "datastore"
  - Invalid layer: component "db" declared under system instead of container

Summary: 1 warnings, 2 errors
```

### Flags

| Flag                 | Description                        |
| -------------------- | ---------------------------------- |
| `--json`             | Machine-readable validation output |
| `--rules <file>`     | Load custom validation rules       |
| `--warning-as-error` | Upgrade all warnings to errors     |
| `--no-color`         | Disable ANSI colors                |

### Exit Codes

| Code | Meaning             |
| ---- | ------------------- |
| 0    | Passed              |
| 1    | Validation warnings |
| 2    | Validation errors   |

### JSON Output Format (for CI)

```json
{
  "status": "error",
  "errors": [
    {
      "type": "SemanticError",
      "message": "Unknown reference: datastore",
      "location": {
        "file": "architecture.sruja",
        "line": 15,
        "column": 10
      }
    }
  ],
  "warnings": []
}
```

---

## üß™ CLI Examples in CI

### GitHub Action

```yaml
steps:
  - name: Validate architecture
    run: sruja validate --json
```

### GitLab CI

```yaml
validate_architecture:
  script:
    - sruja validate
```

### Pre-commit Hook

```bash
#!/bin/sh
sruja validate || exit 1
```

---

## üìÅ Internal CLI Folder Structure

When packaged:

```
packages/cli/
   bin/
      arch.ts              # CLI entry point
   commands/
      init.ts              # init command
      compile.ts            # compile command
      validate.ts           # validate command
   utils/
      fs.ts                # File operations (uses ProjectProvider)
      printing.ts           # Terminal output
      parser.ts             # DSL parsing wrapper
      validator.ts          # Validation engine
   types/
      cli.ts                # CLI-specific types
   package.json
```

---

## üß† Why This CLI Design Matters

This CLI becomes:

### ‚úî The Shared Engine Used By:
- Next.js front-end
- Desktop/Electron version
- VSCode extension
- Cloud backend
- CI pipelines
- OSS contributors

### ‚úî The Reference Implementation For:
- DSL parsing
- Compiling
- Validating
- Normalizing architecture models

### ‚úî The Heart of Your Open-Source Value

This CLI is your **Terraform/Prettier moment**.

It makes your architecture modeling system **real**, portable, scriptable, automatable.

---

## üîß Implementation Notes

### MVP Status
- ‚ùå CLI is **post-MVP** (not required for MVP)
- ‚úÖ Core engine (parser, model engine) must be CLI-ready
- ‚úÖ Pure functions enable CLI implementation later

### Post-MVP Implementation
- Create `/packages/cli` package
- Use shared packages: `dsl-parser`, `model-engine`, `schema`
- Implement commands using pure functions
- Use `LocalFilesystemProjectProvider` for file operations
- Package as standalone binary (Bun can create executables)

### Design Principles
- ‚úÖ Pure functions only (no HTTP, DB, cloud)
- ‚úÖ Uses ProjectProvider abstraction
- ‚úÖ Works with APF-1.0 format
- ‚úÖ Exit codes for CI integration
- ‚úÖ JSON output for automation
- ‚úÖ Human-readable output for developers

---

[‚Üê Back to Documentation Index](../README.md)
