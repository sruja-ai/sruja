# Architecture Project Format v1

**Authoritative Specification**

**Status:** Draft (stable enough for MVP)  
**Version:** `APF-1.0`

Complete specification for how architecture projects are structured on disk and in Git.

---

## ğŸ¯ Overview

This format ensures:
- âœ… Git is the source of truth
- âœ… Cloud or self-hosted both work
- âœ… Editor can round-trip everything safely
- âœ… LSP/language server always knows how to load project
- âœ… Users can collaborate through Git PRs
- âœ… CI/CD tools work consistently
- âœ… Strong versioning with stable model.json

This is your **"Terraform .tf + .terraform" moment** â€” this will be your standard.

---

## ğŸ“‚ 1. Project Root

A valid Architecture Project is located at the root of a Git repository and must contain:

### **Required:**
```
architecture.sruja
.architecture/
```

### **Optional (but strongly recommended):**
```
adrs/
journeys/
requirements/
libraries/
diagrams/
architecture/
  domains/
  contexts/
  teams/
  modules/
```

This ensures the architecture project is:
- File-based
- Git-native
- Editor-agnostic
- CLI-friendly

---

## ğŸ“˜ 2. Required Files

### **2.1 `architecture.sruja` (Primary Architecture Specification)**

This is the *canonical* human-authored architecture file.

**Contains:**
- VHLD, HLD, LLD definitions
- Nodes, components, containers, systems
- Connections, flows
- Metadata
- Imports to other `.sruja` files
- References to ADRs/journeys/requirements

**Example:**
```dsl
system "Payment Platform" {
  container api: Service "API Gateway" {
    component auth: Component "Auth Module"
    component billing: Component "Billing Engine"
  }
  external bank: External "Bank API"
  api -> bank: "Submit payment"
}
```

**Rules:**
- Must exist at root
- Must be valid DSL v1
- Must be parseable by the grammar
- Cannot exceed 10MB (soft limit)

---

## ğŸ§¬ 3. `.architecture/` (System Metadata Directory)

This directory stores machine-generated or editor-generated metadata.

### Contents of `.architecture/`
```
.architecture/
   model.json
   config.json
   visual.json
   index.json
   cache/
```

### **3.1 `model.json` (Compiled JSON Model)**

Generated by LSP/CLI from DSL.

**Contains:**
- Canonical AST
- Normalized graph model
- Unique IDs
- Resolved imports
- Validated metadata
- Cross-references

**This file is GOOD to commit to Git.**

This enables:
- Diffing model changes
- Stable history
- Analyzer tools
- Backwards compatibility

**Example:**
```json
{
  "version": "1.0",
  "nodes": [
    {
      "id": "api",
      "type": "service",
      "label": "API Gateway",
      "layer": "container",
      "metadata": {}
    }
  ],
  "edges": [
    {
      "from": "api",
      "to": "bank",
      "label": "Submit payment"
    }
  ],
  "meta": {
    "generatedAt": "2024-01-01T00:00:00Z",
    "dslVersion": "1.0"
  }
}
```

### **3.2 `visual.json` (Visual Layout Metadata)**

Contains positions, zoom, collapsed groups, diagram layouts.

Generated by web/desktop editor.

**Example:**
```json
{
  "nodes": {
    "auth": { "x": 100, "y": 200, "width": 150, "height": 80 },
    "billing": { "x": 300, "y": 200, "width": 150, "height": 80 }
  },
  "edges": {},
  "viewport": { "x": 0, "y": 0, "zoom": 1.0 },
  "layers": {
    "context": { "visible": true },
    "containers": { "visible": true },
    "components": { "visible": false }
  }
}
```

**Rules:**
- **Never** embed this in `.sruja`
- Must remain separate so visuals don't pollute text diffs
- Optional (can be regenerated)
- User-specific (can be gitignored if desired)

### **3.3 `config.json` (Project Configuration)**

Contains:
- DSL version
- Default diagram
- Enabled plugins
- Library paths
- Validation rules

**Example:**
```json
{
  "dslVersion": "2.0",
  "libraries": ["libraries/core.json"],
  "validation": {
    "strictLayers": true,
    "requireDescriptions": false,
    "allowOrphanNodes": false
  },
  "defaultLayer": "containers",
  "plugins": ["validation-engine", "auto-layout"]
}
```

### **3.4 `index.json` (Global Index)**

Computed reference map:
- Node IDs â†’ file locations
- Relationships
- Type index
- Journey links
- ADR links

**Required by LSP for speed.**

**Example:**
```json
{
  "nodes": {
    "api": { "file": "architecture.sruja", "line": 5 },
    "auth": { "file": "architecture.sruja", "line": 6 }
  },
  "adrs": {
    "0001": { "file": "adrs/0001-choose-event-sourcing.md" }
  },
  "journeys": {
    "checkout": { "file": "journeys/checkout.sruja" }
  }
}
```

**Rules:**
- Optional (can be regenerated)
- Cacheable
- Should be gitignored (ephemeral)

### **3.5 `cache/` (Optional)**

Contains ephemeral LSP/CLI cache files.

**Not recommended to commit.**

Add to `.gitignore`.

---

## ğŸ§  4. Domain/Context/Team Directories (Boundaries)

Add boundary metadata as first-class files to enable governance and visualization.

### Structure

```
architecture/
  domains/
    identity.json
    payments.json
  contexts/
    identity.auth.json
    ordering.checkout.json
  teams/
    platform.json
    payments.json
  modules/
    auth.json
    checkout.json
```

### File schemas

- `domains/*.json`
  - `{ id, description?, contexts[] }`
- `contexts/*.json`
  - `{ id, domain, owner?, responsibilities?, modules? }`
- `teams/*.json`
  - `{ id, lead?, slack?, metadata? }`
- `modules/*.json`
  - `{ id, context?, owner? }`

### Example: `architecture/contexts/identity.auth.json`

```json
{
  "id": "auth",
  "domain": "identity",
  "owner": "team.platform",
  "responsibilities": [
    "User authentication",
    "JWT signing"
  ],
  "modules": ["auth"]
}
```

### Context maps (optional)

Store cross-context relationships in `.architecture/model.json` or `architecture/context-map.json`:

```json
[
  { "from": "identity.auth", "to": "ordering.checkout", "type": "customer-supplier" },
  { "from": "ordering.checkout", "to": "inventory.core", "type": "conformist" },
  { "from": "identity.auth", "to": "platform.gateway", "type": "open-host-service" }
]
```

### Rules

- Keep boundary files small and composable
- Validate on CI via validation engine
- Commit to Git (except generated indexes)

## ğŸ“š 4. `adrs/` â€” Architecture Decision Records

Optional but strongly encouraged.

**Format:**
- One ADR per `.md` file
- Must follow MADR or ADR v5 standards
- Filename format: `0001-title.md`

**Example:**
```
adrs/
   0001-use-event-sourcing.md
   0002-choose-postgres.md
```

**Linking inside DSL:**
```dsl
component billing {
  adr "0002-choose-postgres"
}
```

---

## ğŸ‘£ 5. `journeys/` â€” User Journeys & Flows

Stored as DSL or YAML.

**Example:**
```
journeys/
   checkout.sruja
   refund.sruja
```

**Example DSL:**
```dsl
journey "Checkout" {
  title: "User checkout flow"
  steps {
    user -> web "browse products"
    web -> api "add to cart"
    api -> payment "process payment"
  }
}
```

---

## ğŸ“œ 6. `requirements/` â€” Requirements Documentation

Optional directory for functional/non-functional requirements.

**Example:**
```
requirements/
   performance.md
   sla.md
   gdpr.md
```

**Format:** Markdown files with structured requirements.

---

## ğŸ§± 7. `libraries/` â€” Component Libraries (Local/Org)

Holds reusable architecture primitives.

**Example:**
```
libraries/
   core.json
   gdpr-data-store.json
   event-sourced.json
```

**Format:**
- JSON or DSL snippets
- Contains metadata, visuals, and default structures

**Example library file:**
```json
{
  "name": "gdpr-data-store",
  "version": "1.0",
  "nodes": [
    {
      "id": "gdpr-db",
      "type": "database",
      "label": "GDPR Compliant Database",
      "metadata": {
        "encryption": "at-rest",
        "retention": "7-years"
      }
    }
  ]
}
```

---

## ğŸ—º 8. `diagrams/` â€” Multi-Diagram Support

Stores alternate diagram overrides if needed.

**Example:**
```
diagrams/
   context.json
   containers.json
   components.json
   sequence-checkout.json
```

> Useful for projects with multiple large diagrams.

---

## ğŸ”— 9. Imports & References (v1 Rules)

### Valid import sources:
```
libraries/*.json
*.sruja files
journeys/*.sruja
```

### Example:
```dsl
import "./libraries/gdpr-data-store.json"
import "./journeys/checkout.sruja"
```

### Reference syntax:
```dsl
auth -> postgres: "Stores user credentials"
uses adr "0002"
journey "Checkout"
```

---

## ğŸ“¦ 10. Required Compatibility Constraints (v1)

To ensure Git portability + future cloud integration:

### âœ” MUST be file-based
### âœ” No binary blobs (only JSON/YAML/DSL/Markdown)
### âœ” Deterministic serialization ordering
### âœ” Stable IDs across operations
### âœ” Visual metadata isolated (never in DSL)
### âœ” Machine-generated metadata clearly separated
### âœ” DSL is always the human-facing format
### âœ” JSON model is canonical machine format

---

## ğŸ“ 11. Example Complete Repository

```
my-architecture-project/
â”‚
â”œâ”€â”€ architecture.sruja
â”‚
â”œâ”€â”€ .architecture/
â”‚   â”œâ”€â”€ model.json          (committed)
â”‚   â”œâ”€â”€ visual.json         (optional, user-specific)
â”‚   â”œâ”€â”€ config.json         (committed)
â”‚   â”œâ”€â”€ index.json          (optional, cacheable)
â”‚   â””â”€â”€ cache/              (gitignored)
â”‚
â”œâ”€â”€ adrs/
â”‚   â”œâ”€â”€ 0001-choose-event-sourcing.md
â”‚   â””â”€â”€ 0002-adopt-s3-for-storage.md
â”‚
â”œâ”€â”€ journeys/
â”‚   â”œâ”€â”€ checkout.sruja
â”‚   â””â”€â”€ user-onboarding.sruja
â”‚
â”œâ”€â”€ requirements/
â”‚   â”œâ”€â”€ performance.md
â”‚   â””â”€â”€ reliability.md
â”‚
â”œâ”€â”€ libraries/
â”‚   â”œâ”€â”€ core.json
â”‚   â””â”€â”€ compliance.json
â”‚
â””â”€â”€ diagrams/
    â”œâ”€â”€ context.json
    â””â”€â”€ container-view.json
```

---

## ğŸ”’ 12. Git Integration

### Files to Commit:
- âœ… `architecture.sruja` (source of truth)
- âœ… `.architecture/model.json` (canonical model)
- âœ… `.architecture/config.json` (project config)
- âœ… `adrs/*.md` (decision records)
- âœ… `journeys/*.sruja` (user journeys)
- âœ… `requirements/*.md` (requirements)
- âœ… `libraries/*.json` (component libraries)

### Files to Gitignore:
- âŒ `.architecture/cache/` (ephemeral)
- âŒ `.architecture/index.json` (can be regenerated)
- âŒ `.architecture/visual.json` (user-specific, optional)
- âŒ `node_modules/`
- âŒ `.next/`
- âŒ `.turbo/`

### `.gitignore` Example:
```
# Architecture cache
.architecture/cache/
.architecture/index.json

# Optional: user-specific visual layouts
.architecture/visual.json

# Standard ignores
node_modules/
.next/
.turbo/
dist/
*.log
```

---

## ğŸ§  Why This Format Matters

This format ensures:

### âœ” Git is the source of truth
- All changes tracked in Git
- PR-based collaboration
- Version history preserved

### âœ” Cloud or self-hosted both work
- File-based = works anywhere
- No vendor lock-in
- Portable projects

### âœ” Editor can round-trip everything safely
- DSL â†’ Model â†’ DSL is deterministic
- Visual metadata separate from DSL
- No data loss

### âœ” LSP/language server always knows how to load project
- Standard structure
- Predictable file locations
- Fast indexing

### âœ” Users can collaborate through Git PRs
- Text-based diffs
- Clear change history
- Merge-friendly

### âœ” CI/CD tools work consistently
- Standard project format
- Validatable structure
- Automated checks

### âœ” Strong versioning with stable model.json
- Canonical model format
- Backwards compatible
- Migration path

---

## ğŸš€ Implementation Notes

### MVP Implementation:
- âœ… Support `architecture.sruja` at root
- âœ… Generate `.architecture/model.json`
- âœ… Support `.architecture/config.json`
- âœ… Optional: `adrs/` directory
- âŒ Skip `journeys/`, `requirements/`, `libraries/` for MVP (add post-MVP)

### Provider Abstraction:
The `ProjectProvider` interface (see [Architectural Decisions](./architectural-decisions.md)) must support:
- `loadFile('architecture.sruja')`
- `loadFile('.architecture/model.json')`
- `saveFile('architecture.sruja', content)`
- `saveFile('.architecture/model.json', content)`
- `listFiles('adrs/')`

---

[â† Back to Documentation Index](../README.md)
