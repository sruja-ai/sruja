// Architecture model for Sruja's AI-Assisted Development Pipeline
// This models the context provisioning system that provides architectural
// context to AI coding assistants

// Element kinds
person = kind "Person"
system = kind "System"
container = kind "Container"
component = kind "Component"

// Overview
overview {
  summary "Sruja Context Provisioning System"
  audience "Developers using AI coding assistants"
  scope "Context extraction and formatting for AI assistants"
}

// Actors
Developer = person "Developer"

// Main System
ContextProvisioningSystem = system "Context Provisioning System" {
  description "System that extracts and formats architectural context from Sruja DSL for AI coding assistants"
  
  // Existing components that we leverage
  DSLParser = container "DSL Parser" {
    description "Existing parser that processes .sruja files into AST"
    technology "Go, pkg/language"
    Lexer = component "Lexer"
    Parser = component "Parser"
    ASTBuilder = component "AST Builder"
  }
  
  JSONExport = container "JSON Export" {
    description "Existing export system that converts AST to JSON"
    technology "Go, pkg/export/json"
    JSONConverter = component "JSON Converter"
    SchemaValidator = component "Schema Validator"
  }
  
  // New components for context provisioning
  PIMExtractor = container "PIM Extractor" {
    description "Extracts Platform Independent Model from JSON for AI context"
    technology "Go, pkg/context"
    PIMBuilder = component "PIM Builder"
    AbstractionLayer = component "Abstraction Layer"
    PIMValidator = component "PIM Validator"
  }
  
  ContextFormatter = container "Context Formatter" {
    description "Formats PIM into various formats for different AI assistants"
    technology "Go, pkg/context"
    
    FormatRouter = component "Format Router"
    MarkdownFormatter = component "Markdown Formatter" {
      description "Formats context as Markdown for Copilot/Cursor"
    }
    JSONFormatter = component "JSON Formatter" {
      description "Formats context as structured JSON"
    }
    PromptFormatter = component "Prompt Formatter" {
      description "Formats context as prompt-ready text for ChatGPT/Claude"
    }
    TokenOptimizer = component "Token Optimizer" {
      description "Optimizes context for token limits"
    }
  }
  
  TraceabilityManager = container "Traceability Manager" {
    description "Tracks connections between DSL elements, AI prompts, and generated code"
    technology "Go, pkg/traceability"
    LinkStore = component "Link Store" {
      description "Stores traceability links in JSON format"
    }
    LinkQuery = component "Link Query" {
      description "Queries traceability links by DSL element or code file"
    }
    ImpactAnalyzer = component "Impact Analyzer" {
      description "Analyzes impact of architecture changes on code"
    }
  }
  
  OptionalAIAssistant = container "Optional AI Assistant" {
    description "Optional AI features for DSL authoring (not code generation)"
    technology "Go, pkg/ai"
    LLMClient = component "LLM Client" {
      description "Abstracts LLM provider (OpenAI, Anthropic, local)"
    }
    DSLTranslator = component "DSL Translator" {
      description "Translates natural language to DSL"
    }
    ArchitectureAdvisor = component "Architecture Advisor" {
      description "Suggests architecture improvements"
    }
  }
  
  ValidationEngine = container "Validation Engine" {
    description "Enhanced validation for PIM and architecture quality"
    technology "Go, pkg/validation"
    EnhancedPIMValidator = component "Enhanced PIM Validator"
    QualityChecker = component "Quality Checker"
  }
  
  LSPIntegration = container "LSP Integration" {
    description "Provides context via Language Server Protocol for IDE integration"
    technology "Go, pkg/lsp"
    ContextProvider = component "Context Provider"
    HoverEnhancer = component "Hover Enhancer"
  }
  
  CLI = container "CLI" {
    description "Command-line interface for context export and traceability"
    technology "Go, cmd/sruja"
    ContextExportCmd = component "Context Export Command"
    TraceCmd = component "Trace Command"
    OptionalAICmd = component "Optional AI Command"
  }
}

// External systems
AICodingAssistants = system "AI Coding Assistants" {
  description "External AI coding assistants (GitHub Copilot, Cursor, ChatGPT, Claude, etc.)"
  Copilot = container "GitHub Copilot" {
    description "GitHub Copilot AI coding assistant"
  }
  Cursor = container "Cursor AI" {
    description "Cursor AI coding assistant with IDE integration"
  }
  ChatGPT = container "ChatGPT" {
    description "OpenAI ChatGPT for code generation"
  }
  Claude = container "Claude" {
    description "Anthropic Claude for code generation"
  }
}

DeveloperWorkspace = system "Developer Workspace" {
  description "Developer's codebase where code is generated with AI assistance"
  Codebase = container "Codebase" {
    description "Application and infrastructure code"
  }
}

// Internal relationships
ContextProvisioningSystem.DSLParser.Lexer -> ContextProvisioningSystem.DSLParser.Parser "Tokenizes input"
ContextProvisioningSystem.DSLParser.Parser -> ContextProvisioningSystem.DSLParser.ASTBuilder "Builds AST"
ContextProvisioningSystem.DSLParser.ASTBuilder -> ContextProvisioningSystem.JSONExport.JSONConverter "AST to JSON"
ContextProvisioningSystem.JSONExport.JSONConverter -> ContextProvisioningSystem.JSONExport.SchemaValidator "Validates JSON"
ContextProvisioningSystem.JSONExport.JSONConverter -> ContextProvisioningSystem.PIMExtractor.PIMBuilder "JSON to PIM"
ContextProvisioningSystem.PIMExtractor.PIMBuilder -> ContextProvisioningSystem.PIMExtractor.AbstractionLayer "Removes platform details"
ContextProvisioningSystem.PIMExtractor.AbstractionLayer -> ContextProvisioningSystem.PIMExtractor.PIMValidator "Validates PIM structure"
ContextProvisioningSystem.PIMExtractor.PIMValidator -> ContextProvisioningSystem.ContextFormatter.FormatRouter "Routes PIM by format"
ContextProvisioningSystem.ContextFormatter.FormatRouter -> ContextProvisioningSystem.ContextFormatter.MarkdownFormatter "Markdown format"
ContextProvisioningSystem.ContextFormatter.FormatRouter -> ContextProvisioningSystem.ContextFormatter.JSONFormatter "JSON format"
ContextProvisioningSystem.ContextFormatter.FormatRouter -> ContextProvisioningSystem.ContextFormatter.PromptFormatter "Prompt format"
ContextProvisioningSystem.ContextFormatter.MarkdownFormatter -> ContextProvisioningSystem.ContextFormatter.TokenOptimizer "Optimizes tokens"
ContextProvisioningSystem.ContextFormatter.JSONFormatter -> ContextProvisioningSystem.ContextFormatter.TokenOptimizer "Optimizes tokens"
ContextProvisioningSystem.ContextFormatter.PromptFormatter -> ContextProvisioningSystem.ContextFormatter.TokenOptimizer "Optimizes tokens"
ContextProvisioningSystem.TraceabilityManager.LinkStore -> ContextProvisioningSystem.TraceabilityManager.LinkQuery "Provides links"
ContextProvisioningSystem.TraceabilityManager.LinkQuery -> ContextProvisioningSystem.TraceabilityManager.ImpactAnalyzer "Analyzes relationships"
ContextProvisioningSystem.OptionalAIAssistant.LLMClient -> ContextProvisioningSystem.OptionalAIAssistant.DSLTranslator "Provides LLM access"
ContextProvisioningSystem.OptionalAIAssistant.LLMClient -> ContextProvisioningSystem.OptionalAIAssistant.ArchitectureAdvisor "Provides LLM access"
ContextProvisioningSystem.PIMExtractor.PIMValidator -> ContextProvisioningSystem.ValidationEngine.EnhancedPIMValidator "Validates PIM"
ContextProvisioningSystem.ValidationEngine.EnhancedPIMValidator -> ContextProvisioningSystem.ValidationEngine.QualityChecker "Checks quality metrics"
ContextProvisioningSystem.ContextFormatter.FormatRouter -> ContextProvisioningSystem.LSPIntegration.ContextProvider "Provides formatted context"
ContextProvisioningSystem.LSPIntegration.ContextProvider -> ContextProvisioningSystem.LSPIntegration.HoverEnhancer "Enhances hover with context"
ContextProvisioningSystem.ContextFormatter.TokenOptimizer -> ContextProvisioningSystem.CLI.ContextExportCmd "Exports context"
ContextProvisioningSystem.TraceabilityManager.ImpactAnalyzer -> ContextProvisioningSystem.CLI.TraceCmd "Provides traceability"
ContextProvisioningSystem.OptionalAIAssistant.DSLTranslator -> ContextProvisioningSystem.CLI.OptionalAICmd "Provides AI features"
ContextProvisioningSystem.PIMExtractor -> ContextProvisioningSystem.ContextFormatter "PIM to format"
ContextProvisioningSystem.ContextFormatter -> ContextProvisioningSystem.TraceabilityManager "Tracks context exports"
ContextProvisioningSystem.ValidationEngine -> ContextProvisioningSystem.ContextFormatter "Validated PIM"

// User interactions
Developer -> ContextProvisioningSystem.CLI.ContextExportCmd "Exports context"
Developer -> ContextProvisioningSystem.CLI.TraceCmd "Queries traceability"
Developer -> ContextProvisioningSystem.OptionalAIAssistant.DSLTranslator "Gets DSL help"

// Context flow to AI assistants
ContextProvisioningSystem.ContextFormatter.MarkdownFormatter -> AICodingAssistants.Copilot "Markdown context"
ContextProvisioningSystem.ContextFormatter.MarkdownFormatter -> AICodingAssistants.Cursor "Markdown context"
ContextProvisioningSystem.ContextFormatter.PromptFormatter -> AICodingAssistants.ChatGPT "Prompt context"
ContextProvisioningSystem.ContextFormatter.PromptFormatter -> AICodingAssistants.Claude "Prompt context"
ContextProvisioningSystem.LSPIntegration.ContextProvider -> AICodingAssistants.Cursor "IDE context"

// Code generation flow
Developer -> AICodingAssistants.Copilot "Uses context to generate code"
Developer -> AICodingAssistants.Cursor "Uses context to generate code"
AICodingAssistants.Copilot -> DeveloperWorkspace.Codebase "Generated code"
AICodingAssistants.Cursor -> DeveloperWorkspace.Codebase "Generated code"

// Traceability flow
Developer -> ContextProvisioningSystem.TraceabilityManager.LinkStore "Links code to DSL"
DeveloperWorkspace.Codebase -> ContextProvisioningSystem.TraceabilityManager.LinkStore "Tracks code files"

// Stories/Flows
ExportContext = story "Export Context for System" {
  Developer -> ContextProvisioningSystem.CLI.ContextExportCmd "runs: sruja context export --system=OrderService --format=markdown"
  ContextProvisioningSystem.CLI.ContextExportCmd -> ContextProvisioningSystem.ContextFormatter.MarkdownFormatter "formats context"
  ContextProvisioningSystem.ContextFormatter.MarkdownFormatter -> Developer "provides Markdown context"
}

UseContextWithAI = story "Use Context with AI Assistant" {
  Developer -> AICodingAssistants.Copilot "provides context + code request"
  AICodingAssistants.Copilot -> DeveloperWorkspace.Codebase "generates code with architecture awareness"
}

TrackTraceability = story "Track Traceability" {
  Developer -> ContextProvisioningSystem.CLI.TraceCmd "links: sruja trace link --element=system.App.container.Web --file=app/web/server.go"
  ContextProvisioningSystem.CLI.TraceCmd -> ContextProvisioningSystem.TraceabilityManager.LinkStore "stores traceability link"
  DeveloperWorkspace.Codebase -> ContextProvisioningSystem.TraceabilityManager.LinkStore "tracks code file"
}

LSPContextProvision = story "LSP Context Provision" {
  Developer -> ContextProvisioningSystem.LSPIntegration.HoverEnhancer "hovers over DSL element"
  ContextProvisioningSystem.LSPIntegration.ContextProvider -> AICodingAssistants.Cursor "provides context automatically"
}

// Requirements
REQ_CONTEXT_EXPORT = requirement functional "System must export architectural context in multiple formats"
REQ_TOKEN_OPTIMIZATION = requirement performance "Context must be optimized for AI assistant token limits"
REQ_TRACEABILITY = requirement functional "System must track relationships between DSL elements and generated code"
REQ_LSP_INTEGRATION = requirement functional "System must provide context via LSP for IDE integration"
REQ_BACKWARD_COMPAT = requirement constraint "New features must not break existing Sruja functionality"
